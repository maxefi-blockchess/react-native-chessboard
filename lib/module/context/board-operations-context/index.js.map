{"version":3,"names":["React","createContext","useCallback","useImperativeHandle","useMemo","useSharedValue","getChessboardState","useReversePiecePosition","useSetBoard","useBoardPromotion","usePieceRefs","useChessEngine","useChessboardProps","BoardOperationsContext","BoardOperationsContextProviderComponent","forwardRef","ref","children","controller","chess","setBoard","pieceSize","onMove","onChessboardMoveCallback","colors","checkmateHighlight","toTranslation","calculatePosition","selectableSquares","selectedSquare","showPromotionDialog","pieceRefs","turn","reset","value","resetAllHighlightedSquares","isPromoting","from","to","includes","val","x","Math","floor","y","calculatedX","calculatedY","piece","board","type","PAWN","color","WHITE","BLACK","findKing","length","row","col","String","fromCharCode","round","square","get","charAt","moveProgrammatically","promotionPiece","move","promotion","isCheck","in_check","isCheckmate","in_checkmate","highlight","borderColor","state","in_promotion","lastMove","current","enable","onSelect","onSelectPiece","validSquares","moves","map","splittedSquare","split","moveTo","BoardOperationsContextProvider","memo"],"sources":["index.tsx"],"sourcesContent":["import type { PieceType, Square } from 'chess.js';\nimport React, {\n  createContext,\n  useCallback,\n  useImperativeHandle,\n  useMemo,\n} from 'react';\nimport type Animated from 'react-native-reanimated';\nimport { useSharedValue } from 'react-native-reanimated';\nimport { getChessboardState } from '../../helpers/get-chessboard-state';\n\nimport { useReversePiecePosition } from '../../notation';\nimport { useSetBoard } from '../board-context/hooks';\nimport { useBoardPromotion } from '../board-promotion-context/hooks';\nimport type { ChessboardRef } from '../board-refs-context';\nimport { usePieceRefs } from '../board-refs-context/hooks';\nimport { useChessEngine } from '../chess-engine-context/hooks';\nimport { useChessboardProps } from '../props-context/hooks';\n\ntype BoardOperationsContextType = {\n  selectableSquares: Animated.SharedValue<Square[]>;\n  onMove: (from: Square, to: Square) => void;\n  onSelectPiece: (square: Square) => void;\n  moveTo: (to: Square) => void;\n  isPromoting: (from: Square, to: Square) => boolean;\n  selectedSquare: Animated.SharedValue<Square | null>;\n  turn: Animated.SharedValue<'w' | 'b'>;\n};\n\nconst BoardOperationsContext = createContext<BoardOperationsContextType>(\n  {} as any\n);\n\nexport type BoardOperationsRef = {\n  reset: () => void;\n};\n\nconst BoardOperationsContextProviderComponent = React.forwardRef<\n  BoardOperationsRef,\n  { controller?: ChessboardRef; children?: React.ReactNode }\n>(({ children, controller }, ref) => {\n  const chess = useChessEngine();\n  const setBoard = useSetBoard();\n  const {\n    pieceSize,\n    onMove: onChessboardMoveCallback,\n    colors: { checkmateHighlight },\n  } = useChessboardProps();\n  const { toTranslation, calculatePosition } = useReversePiecePosition();\n  const selectableSquares = useSharedValue<Square[]>([]);\n  const selectedSquare = useSharedValue<Square | null>(null);\n  const { showPromotionDialog } = useBoardPromotion();\n  const pieceRefs = usePieceRefs();\n\n  const turn = useSharedValue(chess.turn());\n\n  useImperativeHandle(\n    ref,\n    () => ({\n      reset: () => {\n        selectableSquares.value = [];\n        controller?.resetAllHighlightedSquares();\n        turn.value = chess.turn();\n      },\n    }),\n    [chess, controller, selectableSquares, turn]\n  );\n\n  const isPromoting = useCallback(\n    (from: Square, to: Square) => {\n      if (!to.includes('8') && !to.includes('1')) return false;\n\n      const val = toTranslation(from);\n      const x = Math.floor(val.x / pieceSize);\n      const y = Math.floor(val.y / pieceSize);\n\n      const { x: calculatedX, y: calculatedY } = calculatePosition({\n        x,\n        y,\n      });\n\n      const piece = chess.board()[calculatedY][calculatedX];\n\n      return (\n        piece?.type === chess.PAWN &&\n        ((to.includes('8') && piece.color === chess.WHITE) ||\n          (to.includes('1') && piece.color === chess.BLACK))\n      );\n    },\n    [chess, pieceSize, toTranslation, calculatePosition]\n  );\n\n  const findKing = useCallback(\n    (type: 'wk' | 'bk') => {\n      const board = chess.board();\n      for (let x = 0; x < board.length; x++) {\n        const row = board[x];\n        for (let y = 0; y < row.length; y++) {\n          const col = String.fromCharCode(97 + Math.round(x));\n\n          // eslint-disable-next-line no-shadow\n          const row = `${8 - Math.round(y)}`;\n          const square = `${col}${row}` as Square;\n\n          const piece = chess.get(square);\n          if (piece?.color === type.charAt(0) && piece.type === type.charAt(1))\n            return square;\n        }\n      }\n      return null;\n    },\n    [chess]\n  );\n\n  const moveProgrammatically = useCallback(\n    (from: Square, to: Square, promotionPiece?: PieceType) => {\n      const move = chess.move({\n        from,\n        to,\n        promotion: promotionPiece as any,\n      });\n\n      turn.value = chess.turn();\n\n      if (move == null) return;\n\n      const isCheck = chess.in_check();\n      const isCheckmate = chess.in_checkmate();\n\n      if (isCheck) {\n        const square = findKing(`${chess.turn()}k`);\n        if (!square) return;\n        controller?.highlight({\n          square,\n          color: 'transparent',\n          borderColor: checkmateHighlight,\n        });\n      }\n\n      if (isCheckmate) {\n        const square = findKing(`${chess.turn()}k`);\n        if (!square) return;\n        controller?.highlight({ square, color: checkmateHighlight });\n      }\n\n      onChessboardMoveCallback?.({\n        move,\n        state: {\n          ...getChessboardState(chess),\n          in_promotion: promotionPiece != null,\n        },\n      });\n\n      setBoard(chess.board());\n    },\n    [\n      checkmateHighlight,\n      chess,\n      controller,\n      findKing,\n      onChessboardMoveCallback,\n      setBoard,\n      turn,\n    ]\n  );\n\n  const onMove = useCallback(\n    (from: Square, to: Square) => {\n      selectableSquares.value = [];\n      selectedSquare.value = null;\n      const lastMove = { from, to };\n      controller?.resetAllHighlightedSquares();\n      controller?.highlight({ square: lastMove.from });\n      controller?.highlight({ square: lastMove.to });\n\n      const in_promotion = isPromoting(from, to);\n      if (!in_promotion) {\n        moveProgrammatically(from, to);\n        return;\n      }\n\n      pieceRefs?.current?.[to]?.current?.enable(false);\n      showPromotionDialog({\n        type: chess.turn(),\n        onSelect: (piece) => {\n          moveProgrammatically(from, to, piece);\n          pieceRefs?.current?.[to]?.current?.enable(true);\n        },\n      });\n    },\n    [\n      chess,\n      controller,\n      isPromoting,\n      moveProgrammatically,\n      pieceRefs,\n      selectableSquares,\n      selectedSquare,\n      showPromotionDialog,\n    ]\n  );\n\n  const onSelectPiece = useCallback(\n    (square: Square) => {\n      selectedSquare.value = square;\n\n      const validSquares = (chess.moves({\n        square,\n      }) ?? []) as Square[];\n\n      // eslint-disable-next-line no-shadow\n      selectableSquares.value = validSquares.map((square) => {\n        const splittedSquare = square.split('x');\n        if (splittedSquare.length === 0) {\n          return square;\n        }\n\n        return splittedSquare[splittedSquare.length - 1] as Square;\n      });\n    },\n    [chess, selectableSquares, selectedSquare]\n  );\n\n  const moveTo = useCallback(\n    (to: Square) => {\n      if (selectedSquare.value != null) {\n        controller?.move({ from: selectedSquare.value, to: to });\n        return true;\n      }\n      return false;\n    },\n    [controller, selectedSquare.value]\n  );\n\n  const value = useMemo(() => {\n    return {\n      onMove,\n      onSelectPiece,\n      moveTo,\n      selectableSquares,\n      selectedSquare,\n      isPromoting,\n      turn,\n    };\n  }, [\n    isPromoting,\n    moveTo,\n    onMove,\n    onSelectPiece,\n    selectableSquares,\n    selectedSquare,\n    turn,\n  ]);\n\n  return (\n    <BoardOperationsContext.Provider value={value}>\n      {children}\n    </BoardOperationsContext.Provider>\n  );\n});\n\nconst BoardOperationsContextProvider = React.memo(\n  BoardOperationsContextProviderComponent\n);\n\nexport { BoardOperationsContextProvider, BoardOperationsContext };\n"],"mappings":"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"}